---
import type { Review as AllReviewsResult } from "~/api/reviews";

import { getFluidWidthPosterImageProps } from "~/api/posters";
import { allReviews, getContentPlainText } from "~/api/reviews";
import AstroPageShell from "~/astro/AstroPageShell.astro";
import { Layout } from "~/components/layout/Layout";
import { PosterListItemImageConfig } from "~/components/poster-list/PosterListItem";
import { getReviewProps } from "~/features/review/getReviewProps";
import { Review } from "~/features/review/Review";

type Props = AllReviewsResult;

export async function getStaticPaths() {
  const { reviews } = await allReviews();

  return await Promise.all(
    reviews.map(async (review) => {
      return {
        params: {
          slug: review.slug,
        },
        props: review,
      };
    }),
  );
}

const { rawContent, releaseYear, slug, title } = Astro.props;

const reviewProps = await getReviewProps(Astro.props);

const searchPosterImageProps = await getFluidWidthPosterImageProps(
  slug,
  PosterListItemImageConfig,
);

//trim the string to the maximum length
var description = getContentPlainText(rawContent)
  .replaceAll(/\r?\n|\r/g, " ")
  .slice(0, Math.max(0, 160));

//re-trim if we are in the middle of a word
description = description.slice(
  0,
  Math.max(0, Math.min(description.length, description.lastIndexOf(" "))),
);

let metaTitle = `${title} movie review`;

if (title.length <= 10) {
  metaTitle = `${title} & summary`;
}

metaTitle = `${title} (${releaseYear})`;
---

<AstroPageShell
  canonical={true}
  meta={{ description }}
  openGraph={{ description, type: "article" }}
  title={metaTitle}
>
  <Fragment slot="meta-theme-color">
    <meta
      content="#fff"
      media="(prefers-color-scheme: light)"
      name="theme-color"
    />
    <meta
      content="#322f2f"
      media="(prefers-color-scheme: dark)"
      name="theme-color"
    />
  </Fragment>
  <Layout
    className="flex flex-col"
    data-pagefind-body
    data-pagefind-meta={`image:${searchPosterImageProps.src}`}
  >
    <Review {...reviewProps} />
  </Layout>
</AstroPageShell>
